#!/usr/bin/env ruby

require 'json'
require 'trollop'

opts = Trollop::options do
  banner <<-EOS
Create a new application image from the current directory
  EOS
end

if ARGV.length < 1
  Trollop::die "Please Specify an Deployment File"
end

config = JSON.parse open(ARGV.shift).read

NAME = config['name']
ROOT = File.expand_path File.join( __FILE__, "..")

# Create the base image
CREATE_BASE = "#{ROOT}/binfuse-create-base"
INSTANCE_ID = `#{CREATE_BASE}`

# Install the application
CREATE_INSTALL = "#{ROOT}/binfuse-create-install #{INSTANCE_ID}"
system CREATE_INSTALL

# Package the application
CREATE_PACKAGE = "#{ROOT}/binfuse-create-package #{NAME} #{INSTANCE_ID}"
AMI_ID = `#{CREATE_PACKAGE}`

# Done
now = DateTime.now

config['ami']  = AMI_ID
config['date'] = now

BUILD = "build.#{now}.json"
open(BUILD,'w').write(JSON.generate config)

puts "Wrote Build to #{BUILD}"
