#!/usr/bin/env ruby
#
# Create a new AWS Image
#

require 'open3'
require 'base64'
require 'trollop'

opts = Trollop::options do
  banner <<-EOS
Create a new blank EC2 Image from a base AMI and returns its instance id.

Usage:
  binfuse-deploy-create [options]

where [options] are:
  EOS
  opt :region,      "EC2 Region",       :short => 'r', :type => :string, :default => 'us-west-2'
  opt :ami,         "Base AMI",         :short => 'A', :type => :string, :default => 'ami-7e2da54e'
  opt :keypair,      "Key Pair Name",   :short => 'k', :type => :string, :default => 'NodeFly Master'
  opt :environment, "Environment File", :short => 'E', :type => :string
end

KEY_PAIR=opts[:keypair]
BASE_AMI=opts[:ami]
REGION  =opts[:region]
ENVS    =opts[:environment]

# Launch a New Instance
# - Returns Instance Details (http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/launching-an-instance.html)
run_out = `ec2-run-instances #{BASE_AMI} -k '#{KEY_PAIR}' --region '#{REGION}' --user-data-file #{ENVS}`
run_results = run_out.split
instance_id = run_results[5]
instance_status = run_results[7]

# Return _only_ the Instance ID to STDOUT
# This value is expected to be passed into other scripts
puts instance_id
