#!/usr/bin/env ruby

REGION="us-west-2"
ROOT_DIR = File.expand_path File.join( __FILE__, "..", "..")

instance_id=ARGV[0]

# Wait for the instance to boot
puts "Waiting for Instance to Boot..."
instance_status="unknown"
while instance_status != "running" do
  
  describe_out = `ec2-describe-instances #{instance_id} --region #{REGION}`
  
  describe_results = describe_out.split
  instance_status  = describe_results[9]
  instance_address = describe_results[7]
  
  sleep(10)
  
end

sleep(30)

puts "Instance is Running"
puts "Connecting to #{instance_address}"

system("ssh -o StrictHostKeyChecking=no #{instance_address} < #{ROOT_DIR}/install.bash")

puts "System Ready at #{instance_address}"
puts "Deploying Application"

puts `git push #{instance_address}:bundle/.git master`

