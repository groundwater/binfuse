#!/usr/bin/env ruby

require 'trollop'

USAGE    = <<-EOF
Package a fully configured EC2 image as an AMI

Usage: 
  binfuse-deploy-package <ami-name> <instance-id> [options]
where [options] are:
EOF

opts = Trollop::options do
  banner USAGE
  opt :region,      "EC2 Region",       :short => 'r', :type => :string, :default => 'us-west-2'
end

if ARGV.length < 2
  Trollop::die "Please Specify a Name and Instance ID"
end

REGION=opts[:region]

IMAGE_NAME=ARGV.shift
INSTANCE_ID=ARGV.shift

describe_out = `ec2-describe-instances #{INSTANCE_ID} --region #{REGION}`
describe_results = describe_out.split
instance_status  = describe_results[9]
instance_address = describe_results[7]

mref = `cat .git/refs/heads/master`.slice 0, 10
AMI_NAME = "#{IMAGE_NAME}-#{mref}"

# Create an AMI Snapshot of Running Image
# http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami.html
out = `ec2-create-image -n #{AMI_NAME} #{INSTANCE_ID} --region #{REGION}`
ami = out.split[1]

puts ami
